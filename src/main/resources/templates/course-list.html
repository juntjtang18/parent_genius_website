<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses | Genius Parenting AI</title> 
    <link rel="icon" type="image/jpeg" th:href="@{/images/gpa-logo.jpg}" /> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" /> 
    <link th:href="@{/css/style.css}" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
     <style>
        /* Styles from the previous course-list.html, can be moved to style.css if preferred */
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; } /* Changed font-family */
        .main-content-area { margin-top: 30px; margin-bottom: 30px; } /* Added class for main content */
        .card { margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-header { background-color: #343a40; color: white; }
        .list-group-item { display: flex; justify-content: space-between; align-items: center; }
        .list-group-item .actions a, .list-group-item .actions button { margin-left: 10px; }
        .btn-danger { font-size: 0.9em; padding: 0.3rem 0.6rem; }
        .btn-primary, .btn-info, .btn-success { font-size: 0.9em; padding: 0.3rem 0.6rem; } /* Ensured btn-success is also small */
        #message-area { margin-top: 15px; }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container main-content-area"> 
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Course List</h1>
            <a href="/new-course" class="btn btn-success"><i class="fas fa-plus me-2"></i>Add New Course</a>
        </div>

        <div id="message-area"></div>

        <div class="card">
            <div class="card-header">
                Available Courses
            </div>
            <ul class="list-group list-group-flush" id="course-list-ul">
                <li class="list-group-item" id="loading-courses" style="text-align:center;">Loading courses...</li>
            </ul>
        </div>
    </div>

    <!-- Include Chatbot -->
    <div th:replace="~{fragments/chatbot :: chatbot}"></div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
    /*<![CDATA[*/
    // Using a more specific URL for Strapi API calls passed from the controller
    const STRAPI_API_URL_BASE = /*[[${strapiApiUrl}]]*/ 'http://localhost:1337/api';
    const AUTH_TOKEN = /*[[${strapiToken}]]*/ 'Bearer default-token'; // Ensure this is passed from your Spring controller

    function displayMessage(text, type = 'danger') {
        // Clear previous messages
        $('#message-area').empty();
        // Create new alert
        const alertDiv = $('<div></div>')
            .addClass(`alert alert-${type} alert-dismissible fade show`)
            .attr('role', 'alert')
            .text(text);
        const closeButton = $('<button></button>')
            .attr('type', 'button')
            .addClass('btn-close')
            .attr('data-bs-dismiss', 'alert')
            .attr('aria-label', 'Close');
        alertDiv.append(closeButton);
        $('#message-area').append(alertDiv);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.alert('close');
        }, 5000);
    }

    async function loadCourses() {
        $('#loading-courses').show();
        $('#course-list-ul').find('.course-item').remove(); 
        try {
            const response = await fetch(`${STRAPI_API_URL_BASE}/courses?sort=title:asc`, {
                headers: { 'Authorization': AUTH_TOKEN }
            });
            if (!response.ok) {
                 let errorMsg = `Failed to fetch courses: ${response.status}`;
                 try {
                    const errData = await response.json();
                    errorMsg += ` - ${errData.error?.message || JSON.stringify(errData)}`;
                 } catch(e) { /* Ignore if error response is not JSON */ }
                 throw new Error(errorMsg);
            }
            const result = await response.json();
            const courses = result.data;

            $('#loading-courses').hide();
            if (courses && courses.length > 0) {
                courses.forEach(course => {
                    const courseId = course.id;
                    const title = course.attributes.title || 'Untitled Course';
                    $('#course-list-ul').append(`
                        <li class="list-group-item course-item" data-course-id="${courseId}">
                            <span>${title} (ID: ${courseId})</span>
                            <span class="actions">
                                <a href="/courses/${courseId}/edit" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i> Edit</a>
                                <button class="btn btn-sm btn-danger delete-course-btn" data-course-id="${courseId}"><i class="fas fa-trash-alt"></i> Delete</button>
                            </span>
                        </li>
                    `);
                });
            } else {
                $('#course-list-ul').append('<li class="list-group-item text-muted course-item">No courses found.</li>');
            }
        } catch (error) {
            console.error("Error loading courses:", error);
            $('#loading-courses').hide();
            displayMessage(`Error loading courses: ${error.message}`, 'danger');
        }
    }

    $(document).ready(function() {
        // Ensure strapiApiUrl and strapiToken are correctly passed from Spring controller to the global JS scope
        // For example, they are available to this script.
        if (typeof STRAPI_API_URL_BASE === 'undefined' || typeof AUTH_TOKEN === 'undefined') {
            displayMessage('Configuration error: Strapi API details not available. Please check console.', 'danger');
            console.error('STRAPI_API_URL_BASE or AUTH_TOKEN is undefined. Check Thymeleaf model attributes.');
            return;
        }

        loadCourses();

        $('#course-list-ul').on('click', '.delete-course-btn', async function() {
            const courseId = $(this).data('course-id');
            const courseTitle = $(this).closest('.course-item').find('span:first-child').text();

            // Using a Bootstrap modal for confirmation could be a nice improvement later
            if (confirm(`Are you sure you want to delete the course "${courseTitle}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`${STRAPI_API_URL_BASE}/courses/${courseId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': AUTH_TOKEN }
                    });
                    if (!response.ok) {
                        let errorMsg = `Failed to delete course: ${response.status}`;
                        try {
                           const errorData = await response.json();
                           errorMsg += ` - ${errorData.error?.message || JSON.stringify(errorData)}`;
                        } catch(e) { /* Ignore if error response is not JSON */ }
                        throw new Error(errorMsg);
                    }
                    displayMessage(`Course "${courseTitle}" deleted successfully.`, 'success');
                    $(this).closest('.course-item').remove();
                    if ($('#course-list-ul .course-item').length === 0) { // Check if list is empty after deletion
                         $('#course-list-ul').append('<li class="list-group-item text-muted course-item">No courses found.</li>');
                    }
                } catch (error) {
                    console.error("Error deleting course:", error);
                    displayMessage(`Error deleting course: ${error.message}`, 'danger');
                }
            }
        });
    });
    /*]]>*/
    </script>
</body>
</html>
