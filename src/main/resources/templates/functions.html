<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{functions.title}">Functions - Parent Genius AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link th:href="@{/css/style.css}" rel="stylesheet" />
    <style>
        .carousel-inner {
            height: 80vh; /* Adjusted to fit screen with navbar and footer */
        }
        .carousel-item img {
            width: 100%;
            height: 80vh; /* Matches carousel-inner */
            object-fit: cover;
        }
        .carousel-caption {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            box-sizing: border-box;
            max-height: 200vh;
            overflow-y: auto;
            margin-bottom: 30px; /* Gap above indicators */
        }
        .carousel-caption h2 {
            font-size: 5rem;
            font-weight: bold;
            color: #0F2A24;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
        }
        .carousel-caption ul {
            list-style: none;
            padding: 0;
            font-size: 1.5rem;
            margin: 0;
        }
        .carousel-caption ul li {
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .carousel-caption ul li:last-child {
            margin-bottom: 0;
        }
        .carousel-caption ul li a {
            color: white;
            text-decoration: none;
        }
        .carousel-caption ul li a:hover {
            text-decoration: underline;
        }
        .carousel-caption ul li i {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        .carousel-indicators {
            position: absolute;
            bottom: 30px; /* Raised to be in lower part, not bottom edge */
            left: 0;
            right: 0;
            margin: 0 auto;
            padding: 0;
            z-index: 15;
        }
        .carousel-indicators button {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 5px;
            background-color: #fff;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .carousel-indicators .active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div id="functionsCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators"></div>
        <div class="carousel-inner"></div>
        <button class="carousel-control-prev" type="button" data-bs-target="#functionsCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#functionsCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/marked.min.js"></script>
    <script th:inline="javascript">
        const STRAPI_URL = "http://localhost:8080/api/";
        const AUTH_TOKEN = "Bearer 4ce79caf486d02a1f1d56690e10edb120172038193626d7e7eec0ba7679e219dd616c1a9a6908f079576f0d73d55ffda5fe6b057c2fdf9c19017f802f735d72ca2434a62b3398b4bdea42d84a2a4aab1657a2a3616e6f70c9ac12f80428259fd86dea64d7192e05eafcd90bfc6bbce606453e2e07048d608d52840f242524e41";

        // Fetch all functions from Strapi
        async function fetchFunctions() {
            const response = await fetch(`${STRAPI_URL}functions`, {
                headers: { 'Authorization': AUTH_TOKEN }
            });
            const data = await response.json();
            return data.data;
        }

        // Fetch the first 5 articles for a function with categories populated
        async function fetchArticlesForFunction(functionId) {
            const url = `${STRAPI_URL}articles?filters[functions][id][$in]=${functionId}&pagination[pageSize]=5&sort[0]=sortScore:desc&populate=categories`;
            const response = await fetch(url, {
                headers: { 'Authorization': AUTH_TOKEN }
            });
            const data = await response.json();
            return data.data;
        }

        // Extract title from article content (first heading or paragraph, max 50 chars)
        function extractTitle(content) {
            const html = marked.parse(content, { breaks: true });
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const titleElement = doc.querySelector('h1, h2, h3, h4, h5, h6, p');
            let text = titleElement ? titleElement.textContent.trim() : doc.body.textContent.trim();
            if (!text) text = 'Untitled';
            const title = text.substring(0, 50);
            return text.length > 50 ? title + '...' : title;
        }

        // Dynamically generate the carousel
        async function generateCarousel() {
            const functions = await fetchFunctions();
            const carouselInner = document.querySelector('.carousel-inner');
            const carouselIndicators = document.querySelector('.carousel-indicators');
            carouselInner.innerHTML = '';
            carouselIndicators.innerHTML = '';

            for (let [index, func] of functions.entries()) {
                const articles = await fetchArticlesForFunction(func.id);
                const articleList = articles.map(article => {
                    const title = extractTitle(article.attributes.content);
                    const category = article.attributes.categories.data[0];
                    const categoryId = category ? category.id : '';
                    const iconClass = category && category.attributes.icon_name ? category.attributes.icon_name : 'fas fa-folder';
                    return `
                        <li>
                            <i class="${iconClass}"></i>
                            <a href="/function-article-list?function=${func.id}&category=${categoryId}&article=${article.id}">${title}</a>
                        </li>
                    `;
                }).join('');

                const imageUrl = func.attributes.icon_name ? `/images/${func.attributes.icon_name}` : '/images/default-function.jpg';

                const carouselItem = `
                    <div class="carousel-item ${index === 0 ? 'active' : ''}" id="${func.attributes.name.toLowerCase().replace(/\s+/g, '-')}">
                        <img src="${imageUrl}" alt="${func.attributes.name}" class="d-block w-100">
                        <div class="carousel-caption">
                            <h2>${func.attributes.name}</h2>
                            <ul>${articleList || '<li>No articles available</li>'}</ul>
                        </div>
                    </div>
                `;

                const indicator = `
                    <button type="button" data-bs-target="#functionsCarousel" data-bs-slide-to="${index}" 
                            ${index === 0 ? 'class="active" aria-current="true"' : ''} aria-label="Slide ${index + 1}"></button>
                `;

                carouselInner.insertAdjacentHTML('beforeend', carouselItem);
                carouselIndicators.insertAdjacentHTML('beforeend', indicator);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            if (typeof marked === 'undefined') {
                console.error('marked.js is not loaded');
                return;
            }

            generateCarousel().then(() => {
                const myCarousel = document.querySelector('#functionsCarousel');
                const carousel = new bootstrap.Carousel(myCarousel, {
                    interval: 5000,
                    ride: 'carousel'
                });

                const fragmentToIndex = {};
                document.querySelectorAll('.carousel-item').forEach((item, index) => {
                    fragmentToIndex[item.id] = index;
                });

                const hash = window.location.hash.substring(1);
                if (hash && fragmentToIndex[hash]) {
                    carousel.to(fragmentToIndex[hash]);
                }

                document.querySelectorAll('#functionsDropDown .dropdown-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetId = this.getAttribute('href').split('#')[1];
                        const index = fragmentToIndex[targetId];
                        if (index !== undefined) {
                            carousel.to(index);
                        }
                    });
                });
            }).catch(error => console.error('Error generating carousel:', error));
        });
    </script>
</body>
</html>