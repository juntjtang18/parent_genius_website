<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Course Content | Genius Parenting AI</title>
    <link rel="icon" type="image/jpeg" th:href="@{/images/gpa-logo.jpg}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        body { display: flex; flex-direction: column; min-height: 100vh; font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .main-content { flex: 1; }
        .course-panel { width: 90vw; max-width: 1200px; margin: 30px auto; padding: 30px; background-color: #fff; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        .component { border: 1px solid #d1d8e0; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #fdfdfd; }
        .component-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .drag-handle { cursor: grab; margin-right: 15px; color: #adb5bd; }
        .media-preview { max-width: 250px; max-height: 180px; margin-top: 10px; display: block; border: 1px solid #ddd; padding: 5px; border-radius: 4px; }
        .component-picker-button { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 130px; height: 110px; border: 1px solid #ddd; border-radius: 8px; margin: 10px; cursor: pointer; transition: all 0.2s ease-in-out; background-color: #fff; }
        .component-picker-button:hover { background-color: #f8f9fa; border-color: #0d6efd; box-shadow: 0 0 10px rgba(13,110,253,.2); }
        .component-picker-button i { font-size: 2.2em; margin-bottom: 10px; color: #0d6efd; }
        .form-group { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    <div class="container-fluid main-content">
        <div class="course-panel">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                 <h2 id="course-page-title" class="mb-0">Loading Course...</h2>
                 <div> 
                    <button class="btn btn-success" id="save-course-btn"><i class="fas fa-save me-2"></i>Save Course</button>
                    <a th:href="${returnUrl}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Back to List</a>
                 </div>
            </div>
            <div class="course-editor">
                 <div class="form-group"><label for="course-title-main"><strong>Course Title</strong></label><input type="text" id="course-title-main" class="form-control form-control-lg" /></div>
                <div class="form-group"><label for="course-translations-json"><strong>Translations (JSON)</strong></label><textarea id="course-translations-json" class="form-control" rows="3"></textarea></div>
                <h3 class="mt-5 mb-3">Course Content</h3>
                <div id="course-content-area" class="mt-1"></div>
                <div class="text-center mt-4"><button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addComponentModal"><i class="fas fa-plus me-2"></i>Add New Component</button></div>
            </div>
        </div>
    </div>
    <div id="status-message-container" class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index: 1056;"></div>
    <div id="modals-and-templates">
        <div class="modal fade" id="addComponentModal" tabindex="-1" aria-hidden="true">
        	<div class="modal-dialog modal-dialog-centered modal-lg">
        		<div class="modal-content">
        			<div class="modal-header">
        				<h5 class="modal-title">Pick a Component</h5>
        				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        			</div>
        			<div class="modal-body d-flex justify-content-center flex-wrap">
        				<button class="component-picker-button" data-type="text"><i class="fas fa-paragraph"></i><span>Text</span></button>
        				<button class="component-picker-button" data-type="image"><i class="fas fa-image"></i><span>Image</span></button>
        				<button class="component-picker-button" data-type="video"><i class="fas fa-video"></i><span>Hosted Video</span></button>
        				<button class="component-picker-button" data-type="external-video"><i class="fas fa-link"></i><span>External Video</span></button>
        				<button class="component-picker-button" data-type="quiz"><i class="fas fa-question-circle"></i><span>Quiz</span></button>
        				<button class="component-picker-button" data-type="pagebreaker"><i class="fas fa-arrows-alt-h"></i><span>Page Break</span></button>
        			</div>
        		</div>
        	</div>
        </div>
        <div id="component-templates" style="display: none;">
        	<div class="component text-component template" data-component-strapi-name="coursecontent.text">
        		<div class="component-header">
        			<div>
        				<i class="fas fa-grip-vertical drag-handle"></i>
        				<strong>Text Block</strong>
        			</div>
        			<button class="btn btn-sm btn-danger remove-component-btn"><i class="fas fa-trash-alt"></i></button>
       			</div>
       			<div class="form-group">
       				<label>Text Data</label><textarea class="form-control text-data-input" rows="5"></textarea>
      			</div>
      			<div class="form-group">
      				<label>Styles (JSON)</label><textarea class="form-control style-json-input" rows="3"></textarea>
     			</div>
     		</div>
     		<div class="component image-component template" data-component-strapi-name="coursecontent.image">
     			<div class="component-header">
     				<div>
     					<i class="fas fa-grip-vertical drag-handle"></i><strong>Image</strong>
     				</div>
     				<button class="btn btn-sm btn-danger remove-component-btn"><i class="fas fa-trash-alt"></i></button>
     			</div>
     			<div class="form-group">
     				<img src="#" alt="Preview" class="media-preview image-preview" style="display:none;" />
     			</div>
     			<div class="progress mt-2" style="display: none;">
     				<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">0%</div>
     			</div>
     			<div class="form-group">
     				<label>Upload New Image</label>
     				<input type="file" class="image-file-upload-input form-control" accept="image/*" />
     			</div>
    		</div>
    		<div class="component video-component template" data-component-strapi-name="coursecontent.video">
    			<div class="component-header">
    				<div><i class="fas fa-grip-vertical drag-handle"></i><strong>Hosted Video</strong></div>
    				<button class="btn btn-sm btn-danger remove-component-btn"><i class="fas fa-trash-alt"></i></button>
    			</div>
    			<div class="row">
    				<div class="col-md-6">
	    				<div class="form-group">
	    					<label>Video File</label>
	    					<div class="video-preview-container mt-1 border p-2 rounded bg-light" style="min-height: 150px;"></div>
	    					<div class="progress mt-2" style="display: none;">
	    						<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">0%</div>
	    					</div>
	    					<label class="mt-2">Upload/Replace Video</label>
	    					<input type="file" class="video-file-upload-input form-control" accept="video/*" />
	    				</div>
    				</div>
	    			<div class="col-md-6">
	    				<div class="form-group">
	    					<label>Video Thumbnail</label>
	    					<img src="#" alt="Thumb" class="media-preview thumbnail-preview" style="display:none;" />
	    					<div class="progress mt-2" style="display: none;">
	    						<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">0%</div>
	    					</div>
	    					<label class="mt-2">Upload/Replace Thumbnail</label>
	    					<input type="file" class="thumbnail-file-upload-input form-control" accept="image/*" />
	    				</div>
	    			</div>
    			</div>
    		</div>
    		<div class="component external-video-component template" data-component-strapi-name="coursecontent.external-video">
    			<div class="component-header">
	    			<div>
	    				<i class="fas fa-grip-vertical drag-handle"></i>
	    				<strong>External Video</strong>
	    			</div>
	    			<button class="btn btn-sm btn-danger remove-component-btn"><i class="fas fa-trash-alt"></i></button>
    			</div>
    			<div class="form-group">
    				<label>URL (e.g., YouTube)</label>
    				<input type="text" class="external-video-url-input form-control" />
    			</div>
    			<div class="form-group">
    				<label>Caption</label>
    				<input type="text" class="external-video-caption-input form-control" />
    			</div>
    			<div class="video-preview-container my-2 border p-2 rounded bg-light" style="min-height: 150px;"></div>
    			<!-- 
    			<div class="form-group">
    				<label>Thumbnail</label>
    				<img src="#" alt="Thumb" class="media-preview thumbnail-preview" style="display:none;" />
    				<div class="progress mt-2" style="display: none;">
    					<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">0%</div>
    				</div>
    				<label class="mt-2">Upload/Replace Thumbnail</label>
    				<input type="file" class="thumbnail-file-upload-input form-control" accept="image/*" />
    			</div>
    			 -->
    		</div>
    		<div class="component quiz-component template" data-component-strapi-name="coursecontent.quiz"><div class="component-header"><div><i class="fas fa-grip-vertical drag-handle"></i><strong>Quiz</strong></div><button class="btn btn-sm btn-danger remove-component-btn"><i class="fas fa-trash-alt"></i></button></div><div class="form-group"><label>Question</label><input type="text" class="quiz-question-input form-control" /></div><div class="form-group"><label>Options (JSON)</label><textarea class="quiz-options-input form-control" rows="4"></textarea></div><div class="form-group"><label>Correct Answer</label><input type="text" class="quiz-correct-answer-input form-control" /></div></div><div class="component pagebreaker-component template" data-component-strapi-name="coursecontent.pagebreaker"><div class="component-header"><div><i class="fas fa-grip-vertical drag-handle"></i><strong>Page Break</strong></div><button class="btn btn-sm btn-danger remove-component-btn"><i class="fas fa-trash-alt"></i></button></div><div class="alert alert-info text-center">--- Page Break ---</div></div></div>
    </div>
    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script th:inline="javascript">
    /*<![CDATA[*/
    
    const API_PROXY_URL = /*[[${strapiApiUrl}]]*/ '/api/strapi';
    const STRAPI_ROOT_URL = /*[[${strapiRootUrl}]]*/ 'http://localhost:1337';
    const AUTH_TOKEN = /*[[${strapiToken}]]*/ 'Bearer default-token';
    const COURSE_ID = /*[[${courseId}]]*/ '1';
    let bsModal;
    
    // This is the function that handles the two-stage progress.
    function uploadFileToStrapi(file, onProgress) {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('files', file);
            const xhr = new XMLHttpRequest();
            xhr.open('POST', new URL('api/upload', STRAPI_ROOT_URL).href, true);
            xhr.setRequestHeader('Authorization', AUTH_TOKEN);

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    // This calls the handler in handleFileUpload to update the UI
                    onProgress(percentComplete);
                }
            };
            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    resolve(JSON.parse(xhr.responseText)[0]);
                } else {
                    reject(new Error(`Upload failed: ${xhr.status} ${xhr.statusText}`));
                }
            };
            xhr.onerror = () => reject(new Error('Network error during file upload.'));
            xhr.send(formData);
        });
    }

    $(document).ready(function() {
        bsModal = new bootstrap.Modal(document.getElementById('addComponentModal'));
        loadCourseContent();
        new Sortable(document.getElementById('course-content-area'), { animation: 150, handle: '.drag-handle' });

        $('.component-picker-button').on('click', function() { renderComponent($(this).data('type')); bsModal.hide(); });
        $('#course-content-area').on('click', '.remove-component-btn', function() { $(this).closest('.component').remove(); });
        
        // This function now manages the two-stage progress bar text.
        async function handleFileUpload(context, mediaType) {
            const file = context.files[0];
            if (!file) return;
            const $component = $(context).closest('.component');
            const $progress = $component.find('.progress');
            const $progressBar = $progress.find('.progress-bar');
            
            $(context).prop('disabled', true);
            $('#save-course-btn').prop('disabled', true);
            $progress.show();
            // Reset progress bar style for new uploads
            $progressBar.removeClass('bg-info').addClass('progress-bar-animated');
            
            try {
                // This is the callback function that will be executed by uploadFileToStrapi
                const onProgress = (percent) => {
                    $progressBar.css('width', percent + '%');
                    if (percent < 100) {
                        $progressBar.text(`Uploading: ${percent}%`);
                    } else {
                        // Stage 2: Browser has sent the file, now we wait for the server to finish.
                        $progressBar.addClass('bg-info').removeClass('progress-bar-animated');
                        $progressBar.text('Processing... Please Wait');
                    }
                };
                
                const uploadedFile = await uploadFileToStrapi(file, onProgress);
                
                showStatusMessage('Upload successful!', 'success');

                if (mediaType === 'image') {
                    $component.attr('data-media-id', uploadedFile.id);
                    $component.find('.image-preview').attr('src', getFullStrapiUrl(uploadedFile.url)).show();
                } else if (mediaType === 'video') {
                    $component.attr('data-video-media-id', uploadedFile.id);
                    updateVideoPreview($component.find('.video-preview-container'), uploadedFile.url);
                } else if (mediaType === 'thumbnail') {
                    $component.attr('data-thumbnail-media-id', uploadedFile.id);
                    $component.find('.thumbnail-preview').attr('src', getFullStrapiUrl(uploadedFile.url)).show();
                }
            } catch (error) {
                showStatusMessage(`Upload failed. See browser console for details.`, 'danger');
            } finally {
                $(context).prop('disabled', false).val('');
                $('#save-course-btn').prop('disabled', false);
                $progress.hide();
            }
        };
        
        $('#course-content-area').on('change', '.image-file-upload-input', function() { handleFileUpload(this, 'image'); });
        $('#course-content-area').on('change', '.video-file-upload-input', function() { handleFileUpload(this, 'video'); });
        $('#course-content-area').on('change', '.thumbnail-file-upload-input', function() { handleFileUpload(this, 'thumbnail'); });
        $('#course-content-area').on('input change', '.external-video-url-input', function() { updateVideoPreview($(this).closest('.component').find('.video-preview-container'), $(this).val().trim()); });
        $('#save-course-btn').on('click', saveCourse);
    });

    // --- Other functions are unchanged and included for completeness ---
    function showStatusMessage(message, type = 'danger') { const alertClass = `alert-${type}`; const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'; const $alert = $(`<div class="alert ${alertClass} alert-dismissible fade show" role="alert"><i class="fas ${icon} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`); $('#status-message-container').append($alert); setTimeout(() => $alert.fadeOut(500, () => $alert.remove()), 6000); }
    function getFullStrapiUrl(path) { if (!path || path.startsWith('http')) return path; return new URL(path, STRAPI_ROOT_URL).href; }
    function updateVideoPreview($previewContainer, url) { $previewContainer.empty(); if (!url) return; const videoIdMatch = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); if (videoIdMatch && videoIdMatch[2].length === 11) { $previewContainer.html(`<iframe width="100%" height="200" src="https://www.youtube.com/embed/${videoIdMatch[2]}" frameborder="0" allowfullscreen class="media-preview"></iframe>`); } else { $previewContainer.html(`<video controls class="media-preview" src="${getFullStrapiUrl(url)}" style="max-height: 250px;"></video>`); } }
    function renderComponent(componentType, data = {}) { const $template = $(`#component-templates .${componentType}-component.template`).clone().removeClass('template'); if (data.id) $template.attr('data-strapi-component-id', data.id); switch (componentType) { case 'text': $template.find('.text-data-input').val(data.data || ''); $template.find('.style-json-input').val(JSON.stringify(data.styles || {}, null, 2)); break; case 'image': const imageUrl = data.image_file?.data?.attributes?.url; if (imageUrl) { $template.find('.image-preview').attr('src', getFullStrapiUrl(imageUrl)).show(); $template.attr('data-media-id', data.image_file.data.id); } break; case 'video': if (data.video_file?.data) { updateVideoPreview($template.find('.video-preview-container'), data.video_file.data.attributes.url); $template.attr('data-video-media-id', data.video_file.data.id); } if (data.thumbnail?.data) { $template.find('.thumbnail-preview').attr('src', getFullStrapiUrl(data.thumbnail.data.attributes.url)).show(); $template.attr('data-thumbnail-media-id', data.thumbnail.data.id); } break; case 'external-video': const externalUrl = data.external_url || ''; $template.find('.external-video-url-input').val(externalUrl); $template.find('.external-video-caption-input').val(data.caption || ''); if (externalUrl) updateVideoPreview($template.find('.video-preview-container'), externalUrl); if (data.thumbnail?.data) { $template.find('.thumbnail-preview').attr('src', getFullStrapiUrl(data.thumbnail.data.attributes.url)).show(); $template.attr('data-thumbnail-media-id', data.thumbnail.data.id); } break; case 'quiz': $template.find('.quiz-question-input').val(data.question || ''); $template.find('.quiz-options-input').val(JSON.stringify(data.options || [], null, 2)); $template.find('.quiz-correct-answer-input').val(data.correctAnswer || ''); break; } $('#course-content-area').append($template); }
    async function loadCourseContent() { try { const populateQuery = 'populate[content][populate]=image_file,video_file,thumbnail'; const fetchUrl = `${API_PROXY_URL}/courses/${COURSE_ID}?${populateQuery}`; const response = await fetch(fetchUrl, { headers: { 'Authorization': AUTH_TOKEN } }); if (!response.ok) throw new Error(`Failed to load course (Status: ${response.status})`); const strapiResponse = await response.json(); if (!strapiResponse.data) throw new Error("Course data object not found in API response."); const course = strapiResponse.data.attributes; $('#course-title-main').val(course.title || '');  $('#course-page-title').text('Edit Course: ' + (course.title || 'Untitled')); $('#course-translations-json').val(JSON.stringify(course.translations || {}, null, 2)); $('#course-content-area').empty(); (course.content || []).forEach(c => { const componentType = c.__component.split('.')[1].replace(/_/g, '-'); renderComponent(componentType, c); }); } catch (error) { showStatusMessage(`Could not load course. ${error.message}`, 'danger'); } }
    async function saveCourse() { $('#save-course-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...'); const componentsData = []; let hasError = false; $('#course-content-area .component:not(.template)').each(function() { if (hasError) return; const $c = $(this); const type = $c.data('component-strapi-name'); let payload = { __component: type }; if ($c.attr('data-strapi-component-id')) payload.id = parseInt($c.attr('data-strapi-component-id'), 10); try { if ($c.hasClass('text-component')) { payload.data = $c.find('.text-data-input').val(); payload.styles = JSON.parse($c.find('.style-json-input').val() || '{}'); } else if ($c.hasClass('image-component')) { payload.image_file = $c.attr('data-media-id') ? parseInt($c.attr('data-media-id'), 10) : null; } else if ($c.hasClass('video-component')) { payload.video_file = $c.attr('data-video-media-id') ? parseInt($c.attr('data-video-media-id'), 10) : null; payload.thumbnail = $c.attr('data-thumbnail-media-id') ? parseInt($c.attr('data-thumbnail-media-id'), 10) : null; } else if ($c.hasClass('external-video-component')) { payload.external_url = $c.find('.external-video-url-input').val().trim(); payload.caption = $c.find('.external-video-caption-input').val().trim(); payload.thumbnail = $c.attr('data-thumbnail-media-id') ? parseInt($c.attr('data-thumbnail-media-id'), 10) : null; } else if ($c.hasClass('quiz-component')) { payload.question = $c.find('.quiz-question-input').val(); payload.options = JSON.parse($c.find('.quiz-options-input').val() || '[]'); payload.correctAnswer = $c.find('.quiz-correct-answer-input').val(); } else if ($c.hasClass('pagebreaker-component')) { payload.backbutton = true; payload.nextbutton = true; } } catch (e) { showStatusMessage(`Error in component data: ${e.message}`, 'danger'); hasError = true; } componentsData.push(payload); }); if (hasError) { $('#save-course-btn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save Course'); return; } try { const finalPayload = { data: { title: $('#course-title-main').val().trim(), content: componentsData, translations: JSON.parse($('#course-translations-json').val() || '{}') }}; const response = await fetch(`${API_PROXY_URL}/courses/${COURSE_ID}`, { method: 'PUT', headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json' }, body: JSON.stringify(finalPayload) }); if (!response.ok) throw new Error(`Save failed: ${response.statusText} ${await response.text()}`); showStatusMessage('Course saved successfully!', 'success'); setTimeout(loadCourseContent, 1200); } catch (error) { showStatusMessage(`Save failed: ${error.message}`, 'danger'); } finally { $('#save-course-btn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save Course'); } }
    /*]]>*/
    </script>
</body>
</html>