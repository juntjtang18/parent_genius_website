<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Expert Essays</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
            font-family: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .main-content {
            flex: 1;
        }
        .expert-panel {
            width: 90vw;
            max-width: 1000px;
            margin: 30px auto;
            padding: 24px 28px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        .expert-essay-item + .expert-essay-item {
            border-top: 1px solid #e5e7eb;
            padding-top: 16px;
            margin-top: 16px;
        }
        .expert-essay-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .expert-essay-desc {
            white-space: pre-line;
        }
    </style>
        <!-- Hero-specific styles (copied from seg-emotion-top) -->
    <style>
      /* === Hero styles copied from seg-emotion-top === */

      :root{
        --gp-white: #fff;
        --gp-blue-500: #3b82f6;
        --gp-blue-700: #2563eb;
        --gp-violet-500: #6c6ff7;
        --gp-ink-900: #111827;
        --gp-ink-600: #374151;
        --gp-ink-500: #6B7280;
        --grad-hero: linear-gradient(180deg, var(--gp-blue-500) 0%, var(--gp-blue-700) 55%, var(--gp-violet-500) 100%);
        --grad-cta: linear-gradient(135deg, var(--gp-blue-500) 0%, var(--gp-violet-500) 60%);
        --grad-btn: linear-gradient(90deg, #2ED3B7 0%, #1EC7E6 100%);
        --shadow-1: 0 12px 28px rgba(15,23,42,.08);
        --shadow-2: 0 16px 34px rgba(59,130,246,.28);
        --shadow-cta: 0 10px 20px rgba(23,162,184,.25);
        --shadow-cta-hover: 0 12px 26px rgba(23,162,184,.32);
        --radius-xl: 9999px;
        --container-pad: clamp(24px, 5vw, 64px);
      }

      .about-hero {
        position: relative;
        overflow: hidden;
        color: #fff;
      }
      .about-hero::before {
        content: "";
        position: absolute;
        inset: 0;
        background: var(--grad-hero);
        z-index: 0;
      }
      .about-hero .container-xxl {
        position: relative;
        z-index: 2;
      }
      .about-hero-row {
        min-height: clamp(520px, 72vh, 820px);
      }
      .about-hero-title {
        font-weight: 600;
        font-size: 60px;
        line-height: 70px;
        margin: 0 0 12px;
      }
      .about-hero-sub {
        font-size: 20px;
        line-height: 32px;
        font-weight: 400;
        max-width: 60ch;
        color: rgba(255,255,255,.95);
        padding-bottom: 60px;
      }
      .about-hero-left {
        display: flex;
        align-items: center;
      }
      .about-hero-left-inner {
        padding-block: 64px;
        padding-inline: clamp(24px, 5vw, 64px);
      }

      .about-hero-art {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: min(46vw, 860px);
        display: flex;
        align-items: stretch;
        justify-content: flex-end;
        z-index: 1;
        pointer-events: none;
      }
      .about-hero-art-img {
        height: 100%;
        width: auto;
        object-fit: contain;
        object-position: right center;
        display: block;
      }
      @media (max-width: 991.98px) {
        .about-hero-art {
          display: none;
        }
      }
    </style>

</head>
<body>

    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <!-- ===== hero section, but parameterized ===== -->
    <section class="about-hero">
	<div class="about-hero-art" aria-hidden="true"
	     th:with="
	        sid=${(expertSectionId != null and expertSectionId > 0) ? expertSectionId : 1},
	        idx=${((sid - 1) % 5) + 1},
	        idx2=${#numbers.formatInteger(idx, 2)}
	     ">
	  <img th:src="@{'/images/expertessay/expert-' + ${idx2} + '.png'}"
	       alt=""
	       class="about-hero-art-img">
	</div>

        <div class="container-xxl">
            <div class="row g-0 about-hero-row">
                <div class="col-12 col-lg-7 about-hero-left">
                    <div class="about-hero-left-inner">
                        <!-- Hero title = expert section title -->
                        <h1 class="about-hero-title"
                            th:text="${expertSectionTitle}">Expert Section</h1>

                        <!-- Hero subtitle = expert section description -->
                        <p class="about-hero-sub">
                            <span th:text="${expertSectionDescription}">
                                Expert section description goes here.
                            </span>
                        </p>

                    </div>
                </div>
            </div>
        </div>
    </section>



    <!-- Chatbot -->
    <div th:replace="~{fragments/chatbot :: chatbot}"></div>

    <div class="container-fluid main-content">
        <div class="expert-panel">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
                <div>
                    <h1 class="h3 mb-1">
                        <span th:text="${expertSectionTitle}">Expert Section Title</span>
                    </h1>
                    <p class="text-muted mb-0">
                        Expert essays in this section.
                    </p>
                </div>
                <div class="d-flex align-items-center gap-2">
					<div th:if="${#authorization.expression('hasAnyRole(''EDITOR'', ''ADMIN'')')}">
					    <a th:href="@{|/new-expertessay?sectionId=${expertSectionId}|}" class="btn btn-primary">
					        <i class="fas fa-plus me-2"></i>New Expert Essay
					    </a>
					</div>

                </div>
            </div>

            <div id="alert-container"></div>

            <!-- Loading indicator -->
            <div id="loading-spinner" class="text-center my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">Loading expert essays...</p>
            </div>

            <!-- Container for essay list -->
            <div id="expert-essay-list" class="mt-3"></div>

            <!-- No essays message -->
            <div id="no-essays-message" class="text-muted mt-3 d-none">
                No expert essays found in this section yet.
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const strapiApiUrl    = /*[[${strapiApiUrl}]]*/ '';
        //const strapiToken     = /*[[${strapiToken}]]*/ '';
        const expertSectionId = /*[[${expertSectionId}]]*/ 0;

        const essayListEl       = document.getElementById('expert-essay-list');
        const loadingSpinnerEl  = document.getElementById('loading-spinner');
        const noEssaysMessageEl = document.getElementById('no-essays-message');
        const alertContainerEl  = document.getElementById('alert-container');
        const userCanEdit = /*[[${#authorization.expression('hasAnyRole(''EDITOR'', ''ADMIN'')')}]]*/ false;

        document.addEventListener('DOMContentLoaded', () => {
            loadExpertEssays();
        });

        function showAlert(message, type) {
            alertContainerEl.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        async function loadExpertEssays() {
            if (!expertSectionId) {
                loadingSpinnerEl.style.display = 'none';
                showAlert('No expert section selected.', 'danger');
                return;
            }

            const url =
                `${strapiApiUrl}/expert-essays` +
                `?populate=icon_image,expert_section` +
                `&filters[expert_section][id][$eq]=${expertSectionId}` +
                `&sort=title:asc`;

            try {
            	const res = await fetch(url, {
            	    method: 'GET'
            	});

            	if (!res.ok) {
            	    throw new Error(`HTTP error! status: ${res.status}`);
            	}

                const body = await res.json();
                const essays = body.data || [];

                renderExpertEssays(essays);
            } catch (err) {
                console.error('Error fetching expert essays:', err);
                showAlert('Could not load expert essays. Please try again later.', 'danger');
            } finally {
                loadingSpinnerEl.style.display = 'none';
            }
        }

        function renderExpertEssays(essays) {
            essayListEl.innerHTML = '';

            if (!essays.length) {
                noEssaysMessageEl.classList.remove('d-none');
                return;
            } else {
                noEssaysMessageEl.classList.add('d-none');
            }

            essays.forEach(essay => {
                const id   = essay.id;
                const attr = essay.attributes || {};

                const title = attr.title || '(Untitled)';
                const desc  = attr.description || '';
                const url   = attr.url || '#';

                const itemDiv = document.createElement('div');
                itemDiv.className = 'expert-essay-item';

                // Title row: external URL + edit link
                const titleRow = document.createElement('div');
                titleRow.className = 'd-flex align-items-center justify-content-between mb-1 flex-wrap gap-2';

                const titleSpan = document.createElement('div');
                titleSpan.className = 'expert-essay-title';

                const link = document.createElement('a');
                link.href = url || '#';
                link.target = '_blank';
                link.rel = 'noopener';
                link.className = 'text-decoration-none';
                link.innerHTML = `
                    ${escapeHtml(title)}
                    ${url ? '<i class="fas fa-arrow-up-right-from-square ms-1 small text-muted"></i>' : ''}
                `;

                titleSpan.appendChild(link);
                titleRow.appendChild(titleSpan);

                if (userCanEdit) {
                    const actionDiv = document.createElement('div');
                    const editLink = document.createElement('a');
                    editLink.href = `/expertessay/${id}/edit?sectionId=${expertSectionId}`;
                    editLink.className = 'btn btn-sm btn-outline-secondary';
                    editLink.innerHTML = `<i class="fas fa-pen me-1"></i>Edit`;
                    actionDiv.appendChild(editLink);
                    titleRow.appendChild(actionDiv);
                }

                // Description
                const descP = document.createElement('p');
                descP.className = 'mb-1 text-muted expert-essay-desc';
                descP.textContent = desc;

                itemDiv.appendChild(titleRow);
                itemDiv.appendChild(descP);

                essayListEl.appendChild(itemDiv);
            });
        }

        // Simple HTML escaping for strings used in innerHTML
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
